<{extends 'base.html'}>

<{block name=title}>Chatting room<{/block}>
<{block name=static}>
<style type="text/css">
    #chat-section{ background-color: #dddddd; padding: 20px 0; border-radius: 5px; height: 100%;}
    .right-content{border-left: 1px solid rgba(48,48,48,0.8);height: 100%; overflow: auto;}

    .title {text-shadow: 1px 1px 1px #890729; text-align: center;}
    .back-btn{display:block; float:left; height:40px; width:0; margin-top:10px; position: relative;}
    .back-btn::before {content:''; display:block; position: absolute; top:6px; left:16px; width:24px;
        height:24px; border-top:4px solid #FFFFFF; border-left:4px solid #FFFFFF; transform: rotate(-45deg); border-radius: 4px;}

    .message{}
    .message::after{content:''; display: block; height:0; width:100%; clear: both;}
    .avatar{width:36px; height:36px;  margin:5px; border-radius: 5px; border: 2px solid #DEDEDE;}
    .message-content{border-radius: 6px; margin:5px; line-height: 28px; min-height:28px; padding:2px 10px; font-size: 14px; position:relative; max-width:60%;}
    .message-other .avatar{float:left; background: #282C34;}
    .message-other .message-content{float:left; background: #FFFFFF; margin-left:10px;}
    .message-other .message-content::after{content:''; display: block; width:0px; height:0px;
        border-right: 8px white solid;
        border-top: 6px solid rgba(0,0,0,0);
        border-bottom: 6px solid rgba(0,0,0,0);
        left:-8px; top:8px; position: absolute;
    }
    .message-mine .avatar{float:right; background: orangered;}
    .message-mine .message-content{float:right; background: lightgreen; margin-right:10px;}
    .message-mine .message-content::after{content:''; display: block; width:0px; height:0px;
        border-left: 8px lightgreen solid;
        border-top: 6px solid rgba(0,0,0,0);
        border-bottom: 6px solid rgba(0,0,0,0);
        right:-8px; top:8px; position: absolute;}
</style>
<{/block}>
<{block name=content}>
<div id="chat-section" class="container">
    <div class="left-menu col-md-3">
        <span class="back-btn"></span>
        <div class="title">Dapianzi</div>
    </div>
    <div class="right-content col-md-9">
        <div id="message-container">
            <div class="message message-other">
                <div class="avatar"></div>
                <div class="message-content">How are you?</div>
            </div>
            <div class="message message-mine">
                <div class="avatar"></div>
                <div class="message-content">Fine, thank you. And you?</div>
            </div>
            <div class="message message-other">
                <div class="avatar"></div>
                <div class="message-content">I'm fine, too.</div>
            </div>
        </div>
        <div id="message-sender">
            <div class="input-group">
                <input type="text" class="form-control" id="msg-text" placeholder="Text...">
                <span class="input-group-btn">
                    <button class="btn btn-default" id="send-emoji" type="button">^.^</button>
                </span>
                <span class="input-group-btn">
                    <button class="btn btn-default" id="send-text" type="button">Go!</button>
                </span>
            </div>
        </div>
    </div>
</div>
<{/block}>
<{block name=js}>
<script type="text/javascript">
    var js_chat = {
        ws: null,
        ws_open: false,
        uid: <{$user.id}>,

        ini: function(){
            var self = this;
            this.ws = new WebSocket("ws://127.0.0.1:1988");
            this.ws.onopen = function(evt) {
                self.wsOpen(evt);
                $('#send-text').removeClass('disabled');
                $('#send-text').on('click', function() {
                    var text = $('#msg-text').val();
                    if ('' !== text) {
                        self.sendMsg({'type': 'text', 'body': text});
                        $('#msg-text').val('').focus();
                    }
                });
                $('#msg-text').on('keyup', function(e) {
                    if (e.keyCode == 13) {
                        var text = $(this).val();
                        if ('' !== text) {
                            self.sendMsg({'type': 'text', 'body': text});
                            $(this).val('').focus();
                        }
                    }
                });
                self.sendMsg({
                    'uid': 'dapianzi',
                    'type': 'init',
                    'code': 0,
                    'body': 'init',
                });
            }

            this.ws.onmessage = function(evt) {
                self.wsMessage(evt);
            }
            this.ws.onclose = function(evt) {
                self.wsClose(evt);
                console.log('聊天服务器已断开..');
                window.setTimeout(function(){
                    self.ini();
                }, 5000);
                $('#send-text').addClass('disabled');
            }

        },
        wsOpen: function(evt) {
            console.log('Connection open ...');
            //console.log(evt);
        },
        wsMessage: function(evt) {
            //console.log(evt);
            this.insertMsg(evt.data);
        },
        wsClose: function(evt) {
            console.log('Connection closed.');
            //console.log(evt);
        },
        sendMsg: function(msg) {
            msg = $.extend({
                "uid": 'dapianzi',
                "type": 'msg',
                "code": 0,
                "body": ''
            }, msg);
            //this.ws.send(JSON.stringify(msg));
            this.ws.send(msg.body);
            this.insertMsg(msg.body, msg.type, this.uid);
        },
        insertMsg: function(content, type, sender) {
            content = content.replace(/\\n/g, '<br />');
            var cls = sender==this.uid ? 'mine' : 'other';
            $('#message-container').append('<div class="message message-'+ cls +'"><div class="avatar"></div>' +
                    '<div class="message-content message-'+ type +'">' + content + '</div></div>');
            $('#message-container').scrollTop($('#message-container').height() - $('.right-content').height());
        }
    }
    $(function(){
        js_chat.ini();
    });

</script>
<{/block}>